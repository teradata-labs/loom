name: Publish to Homebrew Tap

permissions:
  contents: read

on:
  # Run when release is published (after release workflow completes)
  release:
    types: [published]

  # Manual trigger
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.0.2)'
        required: true
        type: string

jobs:
  submit-to-homebrew-tap:
    name: Update Homebrew Tap
    runs-on: macos-latest
    steps:
      - name: Checkout loom repo
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Extract version from release tag
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Publishing version: $VERSION"

      - name: Verify release exists
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Check if release exists
          if ! gh release view "v$VERSION" --repo ${{ github.repository }}; then
            echo "Error: Release v$VERSION does not exist"
            exit 1
          fi

          # Verify binaries exist
          URLS=(
            "https://github.com/${{ github.repository }}/releases/download/v${VERSION}/loom-darwin-amd64.tar.gz"
            "https://github.com/${{ github.repository }}/releases/download/v${VERSION}/loom-darwin-arm64.tar.gz"
            "https://github.com/${{ github.repository }}/releases/download/v${VERSION}/looms-darwin-amd64.tar.gz"
            "https://github.com/${{ github.repository }}/releases/download/v${VERSION}/looms-darwin-arm64.tar.gz"
          )

          for url in "${URLS[@]}"; do
            echo "Checking $url..."
            if ! curl --head --silent --fail -L "$url" > /dev/null; then
              echo "Error: Binary not found at $url"
              exit 1
            fi
          done

          echo "All release binaries verified"

      - name: Calculate SHA256 hashes
        id: hashes
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Download and hash loom binaries
          curl -L -o loom-amd64.tar.gz "https://github.com/${{ github.repository }}/releases/download/v${VERSION}/loom-darwin-amd64.tar.gz"
          LOOM_AMD64_HASH=$(shasum -a 256 loom-amd64.tar.gz | awk '{print $1}')

          curl -L -o loom-arm64.tar.gz "https://github.com/${{ github.repository }}/releases/download/v${VERSION}/loom-darwin-arm64.tar.gz"
          LOOM_ARM64_HASH=$(shasum -a 256 loom-arm64.tar.gz | awk '{print $1}')

          # Download and hash looms binaries
          curl -L -o looms-amd64.tar.gz "https://github.com/${{ github.repository }}/releases/download/v${VERSION}/looms-darwin-amd64.tar.gz"
          LOOMS_AMD64_HASH=$(shasum -a 256 looms-amd64.tar.gz | awk '{print $1}')

          curl -L -o looms-arm64.tar.gz "https://github.com/${{ github.repository }}/releases/download/v${VERSION}/looms-darwin-arm64.tar.gz"
          LOOMS_ARM64_HASH=$(shasum -a 256 looms-arm64.tar.gz | awk '{print $1}')

          echo "loom_amd64_hash=$LOOM_AMD64_HASH" >> $GITHUB_OUTPUT
          echo "loom_arm64_hash=$LOOM_ARM64_HASH" >> $GITHUB_OUTPUT
          echo "looms_amd64_hash=$LOOMS_AMD64_HASH" >> $GITHUB_OUTPUT
          echo "looms_arm64_hash=$LOOMS_ARM64_HASH" >> $GITHUB_OUTPUT

          echo "loom-darwin-amd64 hash: $LOOM_AMD64_HASH"
          echo "loom-darwin-arm64 hash: $LOOM_ARM64_HASH"
          echo "looms-darwin-amd64 hash: $LOOMS_AMD64_HASH"
          echo "looms-darwin-arm64 hash: $LOOMS_ARM64_HASH"

      - name: Clone homebrew-tap
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          # Clone homebrew-tap directly (no fork needed since we own it)
          gh repo clone teradata-labs/homebrew-tap homebrew-tap
          cd homebrew-tap
          git checkout main

          # Configure git to use the PAT token for authentication
          git config --global url."https://x-access-token:${GH_TOKEN}@github.com/".insteadOf "https://github.com/"

      - name: Update formulas
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          LOOM_AMD64_HASH="${{ steps.hashes.outputs.loom_amd64_hash }}"
          LOOM_ARM64_HASH="${{ steps.hashes.outputs.loom_arm64_hash }}"
          LOOMS_AMD64_HASH="${{ steps.hashes.outputs.looms_amd64_hash }}"
          LOOMS_ARM64_HASH="${{ steps.hashes.outputs.looms_arm64_hash }}"

          cd homebrew-tap

          # Update loom.rb
          sed -i '' "s/version \".*\"/version \"$VERSION\"/" Formula/loom.rb
          sed -i '' "s|releases/download/v[0-9.]*/loom-darwin-arm64.tar.gz|releases/download/v$VERSION/loom-darwin-arm64.tar.gz|" Formula/loom.rb
          sed -i '' "s|releases/download/v[0-9.]*/loom-darwin-amd64.tar.gz|releases/download/v$VERSION/loom-darwin-amd64.tar.gz|" Formula/loom.rb

          # Update SHA256 for arm64
          sed -i '' "/loom-darwin-arm64.tar.gz/,/sha256/s/sha256 \".*\"/sha256 \"$LOOM_ARM64_HASH\"/" Formula/loom.rb
          # Update SHA256 for amd64
          sed -i '' "/loom-darwin-amd64.tar.gz/,/sha256/s/sha256 \".*\"/sha256 \"$LOOM_AMD64_HASH\"/" Formula/loom.rb

          # Update loom-server.rb
          sed -i '' "s/version \".*\"/version \"$VERSION\"/" Formula/loom-server.rb
          sed -i '' "s|releases/download/v[0-9.]*/looms-darwin-arm64.tar.gz|releases/download/v$VERSION/looms-darwin-arm64.tar.gz|" Formula/loom-server.rb
          sed -i '' "s|releases/download/v[0-9.]*/looms-darwin-amd64.tar.gz|releases/download/v$VERSION/looms-darwin-amd64.tar.gz|" Formula/loom-server.rb

          # Update SHA256 for arm64
          sed -i '' "/looms-darwin-arm64.tar.gz/,/sha256/s/sha256 \".*\"/sha256 \"$LOOMS_ARM64_HASH\"/" Formula/loom-server.rb
          # Update SHA256 for amd64
          sed -i '' "/looms-darwin-amd64.tar.gz/,/sha256/s/sha256 \".*\"/sha256 \"$LOOMS_AMD64_HASH\"/" Formula/loom-server.rb

          echo "Updated formulas:"
          cat Formula/loom.rb | grep -A 2 "version\|url\|sha256"
          echo "---"
          cat Formula/loom-server.rb | grep -A 2 "version\|url\|sha256"

      - name: Create update branch and commit via API
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BRANCH="loom-${VERSION}"

          cd homebrew-tap

          # Get current main branch SHA
          MAIN_SHA=$(git rev-parse main)
          echo "Main branch SHA: $MAIN_SHA"

          # Read updated file contents
          LOOM_CONTENT=$(cat Formula/loom.rb | base64)
          LOOMS_CONTENT=$(cat Formula/loom-server.rb | base64)

          # Create/update branch via API
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/teradata-labs/homebrew-tap/git/refs \
            -f "ref=refs/heads/${BRANCH}" \
            -f "sha=${MAIN_SHA}" \
            2>/dev/null || \
          gh api \
            --method PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/teradata-labs/homebrew-tap/git/refs/heads/${BRANCH} \
            -f "sha=${MAIN_SHA}" \
            -F "force=true"

          # Get current tree
          TREE_SHA=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/teradata-labs/homebrew-tap/git/trees/${MAIN_SHA} \
            --jq '.sha')

          # Create blobs for updated files
          LOOM_BLOB=$(gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/teradata-labs/homebrew-tap/git/blobs \
            -f "content=${LOOM_CONTENT}" \
            -f "encoding=base64" \
            --jq '.sha')

          LOOMS_BLOB=$(gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/teradata-labs/homebrew-tap/git/blobs \
            -f "content=${LOOMS_CONTENT}" \
            -f "encoding=base64" \
            --jq '.sha')

          # Create new tree with updated files
          NEW_TREE=$(gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/teradata-labs/homebrew-tap/git/trees \
            -f "base_tree=${TREE_SHA}" \
            -f "tree[][path]=Formula/loom.rb" \
            -f "tree[][mode]=100644" \
            -f "tree[][type]=blob" \
            -f "tree[][sha]=${LOOM_BLOB}" \
            -f "tree[][path]=Formula/loom-server.rb" \
            -f "tree[][mode]=100644" \
            -f "tree[][type]=blob" \
            -f "tree[][sha]=${LOOMS_BLOB}" \
            --jq '.sha')

          # Create commit via API (GitHub will sign it automatically)
          COMMIT_SHA=$(gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/teradata-labs/homebrew-tap/git/commits \
            -f "message=loom: Update to version ${VERSION}" \
            -f "tree=${NEW_TREE}" \
            -f "parents[]=${MAIN_SHA}" \
            --jq '.sha')

          echo "Created commit: $COMMIT_SHA"

          # Update branch reference to point to new commit
          gh api \
            --method PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/teradata-labs/homebrew-tap/git/refs/heads/${BRANCH} \
            -f "sha=${COMMIT_SHA}"

          echo "Branch ${BRANCH} updated with signed commit"

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BRANCH="loom-${VERSION}"

          cd homebrew-tap

          gh pr create \
            --repo teradata-labs/homebrew-tap \
            --title "loom: Update to version $VERSION" \
            --body "Updates Loom formulas to version $VERSION

          ## Changes
          - Update loom to v$VERSION
          - Update loom-server to v$VERSION
          - Update SHA256 hashes for all architectures

          ## Verification
          - Release: https://github.com/teradata-labs/loom/releases/tag/v$VERSION
          - Binaries verified and hashes calculated from official release

          Automated PR from GitHub Actions." \
            --head "$BRANCH" \
            --base main

      - name: Summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "âœ… Homebrew Tap PR submitted successfully!"
          echo ""
          echo "Version: $VERSION"
          echo "Check PR status at: https://github.com/teradata-labs/homebrew-tap/pulls"
