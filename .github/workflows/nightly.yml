name: Nightly Build

on:
  schedule:
    # Run at 2:00 AM UTC every day (6pm PST / 9pm EST)
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggering
    inputs:
      create_release:
        description: 'Create a nightly pre-release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: read
  checks: write
  actions: read
  security-events: write  # Required for SARIF upload to code scanning

jobs:
  # ============================================================================
  # Job 1: Proto Linting & Generation
  # ============================================================================
  proto:
    name: Proto Lint & Generation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup Buf
        uses: bufbuild/buf-setup-action@a47c93e0b1648d5651a065437926377d060baa99 # v1.50.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Buf Lint
        run: buf lint

      - name: Buf Format Check
        run: buf format --diff --exit-code

      - name: Generate Proto Files
        run: buf generate

      - name: Verify proto generation is up to date
        run: |
          git diff --exit-code gen/ || (
            echo "::error::Generated proto files are out of date. Run 'buf generate' and commit."
            exit 1
          )

  # ============================================================================
  # Job 2: Go Linting
  # ============================================================================
  lint:
    name: Go Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version: '1.25'
          cache: true

      - name: Setup Buf
        uses: bufbuild/buf-setup-action@a47c93e0b1648d5651a065437926377d060baa99 # v1.50.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Proto Files
        run: buf generate

      - name: Generate weaver.yaml from template
        run: go run ./cmd/generate-weaver

      - name: Install linting tools
        run: |
          go install golang.org/x/tools/cmd/goimports@latest
          go install honnef.co/go/tools/cmd/staticcheck@latest

      - name: Run gofmt
        run: |
          gofmt_output=$(find . -name '*.go' -not -path './vendor/*' -not -path './gen/*' -exec gofmt -l {} +)
          if [ -n "$gofmt_output" ]; then
            echo "The following files need formatting:"
            echo "$gofmt_output"
            exit 1
          fi

      - name: Run go vet
        run: go vet ./...

  # ============================================================================
  # Job 3: Unit Tests with Race Detection
  # ============================================================================
  test:
    name: Unit Tests (Race Detection)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version: '1.25'
          cache: true

      - name: Setup Buf
        uses: bufbuild/buf-setup-action@a47c93e0b1648d5651a065437926377d060baa99 # v1.50.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Proto Files
        run: buf generate

      - name: Generate weaver.yaml from template
        run: go run ./cmd/generate-weaver

      - name: Run tests with race detection
        run: |
          go test -tags fts5 -race -v -timeout=10m \
            -coverprofile=coverage.out \
            -covermode=atomic \
            ./pkg/... ./internal/... \
            | tee test-output.log

      - name: Run example tests
        run: |
          go test -tags fts5 -race -v -timeout=5m \
            ./examples/agent-templates \
            ./examples/workflows \
            | tee -a test-output.log

      - name: Check for race conditions
        run: |
          if grep -q "WARNING: DATA RACE" test-output.log; then
            echo "::error::Race condition detected!"
            exit 1
          fi

      - name: Generate coverage report
        run: |
          go tool cover -func=coverage.out | tee coverage-report.txt
          COVERAGE=$(grep "total:" coverage-report.txt | awk '{print $3}')
          echo "## Nightly Coverage: $COVERAGE" >> $GITHUB_STEP_SUMMARY

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: nightly-coverage-${{ github.run_number }}
          path: |
            coverage.out
            coverage-report.txt
            test-output.log

  # ============================================================================
  # Job 4: Multi-Platform Build
  # ============================================================================
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        go-version: ['1.25']
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version: ${{ matrix.go-version }}
          cache: true

      - name: Setup Buf
        uses: bufbuild/buf-setup-action@a47c93e0b1648d5651a065437926377d060baa99 # v1.50.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Proto Files
        run: buf generate

      - name: Build all binaries
        shell: bash
        run: |
          mkdir -p bin
          DATE=$(date +%Y%m%d)

          # Determine OS and extension
          if [ "$RUNNER_OS" = "Windows" ]; then
            EXT=".exe"
          else
            EXT=""
          fi

          # Build looms
          echo "Building looms..."
          go build -tags fts5 -ldflags="-X main.Version=nightly-$DATE" \
            -o "./bin/looms${EXT}" ./cmd/looms

          # Build loom
          echo "Building loom..."
          go build -tags fts5 -ldflags="-X main.Version=nightly-$DATE" \
            -o "./bin/loom${EXT}" ./cmd/loom

          # Build loom-standalone
          echo "Building loom-standalone..."
          go build -tags fts5,standalone -ldflags="-X main.Version=nightly-$DATE" \
            -o "./bin/loom-standalone${EXT}" ./cmd/loom-standalone

      - name: Test binaries
        shell: bash
        run: |
          if [ "$RUNNER_OS" = "Windows" ]; then
            ./bin/looms.exe --version || ./bin/looms.exe --help
            ./bin/loom.exe --help
          else
            ./bin/looms --version || ./bin/looms --help
            ./bin/loom --help
          fi

      - name: Create tarball (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          DATE=$(date +%Y%m%d)
          OS_NAME=$(echo "$RUNNER_OS" | tr '[:upper:]' '[:lower:]')

          if [ "$RUNNER_OS" = "macOS" ]; then
            ARCH=$(uname -m)
          else
            ARCH=$(uname -m)
          fi

          TAR_NAME="loom-nightly-${DATE}-${OS_NAME}-${ARCH}.tar.gz"
          tar -czf "$TAR_NAME" -C bin .

          echo "Created: $TAR_NAME"
          echo "TAR_FILE=$TAR_NAME" >> $GITHUB_ENV

      - name: Create zip (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $DATE = Get-Date -Format "yyyyMMdd"
          $ZIP_NAME = "loom-nightly-${DATE}-windows-amd64.zip"
          Compress-Archive -Path bin/* -DestinationPath $ZIP_NAME

          Write-Host "Created: $ZIP_NAME"
          "ZIP_FILE=$ZIP_NAME" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Upload binaries artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: nightly-binaries-${{ matrix.os }}-${{ github.run_number }}
          path: |
            bin/
            loom-nightly-*.tar.gz
            loom-nightly-*.zip
          retention-days: 30

  # ============================================================================
  # Job 5: Security Scan
  # ============================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version: '1.25'
          cache: true

      - name: Setup Buf
        uses: bufbuild/buf-setup-action@a47c93e0b1648d5651a065437926377d060baa99 # v1.50.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Proto Files
        run: buf generate

      - name: Generate weaver.yaml from template
        run: go run ./cmd/generate-weaver

      - name: Run Gosec Security Scanner
        uses: securego/gosec@398ad549bbf1a51dc978fd966169f660c59774de # v2.23.0
        with:
          args: '-no-fail -fmt sarif -out results.sarif -exclude-dir=gen ./...'

      - name: Fix SARIF schema compliance
        run: |
          # Strip invalid relationships entries that cause SARIF validation failures
          jq '(.runs[].tool.driver.rules // []) |= map(del(.relationships))' \
            results.sarif > results-fixed.sarif
          mv results-fixed.sarif results.sarif

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v4.32.2
        continue-on-error: true  # Don't fail the build if code scanning is not enabled
        with:
          sarif_file: results.sarif

  # ============================================================================
  # Job 6: Create Nightly Release (Optional)
  # ============================================================================
  release:
    name: Create Nightly Pre-Release
    runs-on: ubuntu-latest
    needs: [proto, lint, test, build, security]
    if: github.event.inputs.create_release == 'true' || github.event_name == 'schedule'
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Download all artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          pattern: nightly-binaries-*
          path: artifacts/

      - name: Prepare release assets
        run: |
          DATE=$(date +%Y%m%d)
          mkdir -p release

          # Move all tarballs and zips to release directory
          find artifacts/ -name "*.tar.gz" -exec mv {} release/ \;
          find artifacts/ -name "*.zip" -exec mv {} release/ \;

          ls -lh release/

          echo "RELEASE_TAG=nightly-$DATE" >> $GITHUB_ENV
          echo "RELEASE_DATE=$DATE" >> $GITHUB_ENV

      - name: Create nightly release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: "Nightly Build ${{ env.RELEASE_DATE }}"
          prerelease: true
          draft: false
          body: |
            ## Loom Nightly Build - ${{ env.RELEASE_DATE }}

            Automated nightly build from main branch.

            **âš ï¸ This is a pre-release build for testing purposes.**

            ### Changes
            - Built from commit: ${{ github.sha }}
            - Build number: ${{ github.run_number }}
            - Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ### Downloads
            - **Linux (x64)**: `loom-nightly-${{ env.RELEASE_DATE }}-linux-x86_64.tar.gz`
            - **macOS (Apple Silicon)**: `loom-nightly-${{ env.RELEASE_DATE }}-macos-arm64.tar.gz`
            - **macOS (Intel)**: `loom-nightly-${{ env.RELEASE_DATE }}-macos-x86_64.tar.gz`
            - **Windows (x64)**: `loom-nightly-${{ env.RELEASE_DATE }}-windows-amd64.zip`

            ### Installation
            ```bash
            # Extract tarball
            tar -xzf loom-nightly-*.tar.gz

            # Move binaries to PATH
            sudo mv looms loom loom-standalone /usr/local/bin/

            # Verify installation
            looms --version
            ```

            ---
            ðŸ¤– This release was automatically created by the nightly build workflow.
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # Job 7: Nightly Success Summary
  # ============================================================================
  nightly-summary:
    name: Nightly Build Summary
    runs-on: ubuntu-latest
    needs: [proto, lint, test, build, security]
    if: always()
    steps:
      - name: Check status
        run: |
          RESULTS='${{ toJson(needs) }}'
          echo "$RESULTS" | jq -r 'to_entries[] | "\(.key): \(.value.result)"'

          echo "## Nightly Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run**: [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if any job failed
          if echo "$RESULTS" | jq -e 'to_entries[] | select(.value.result == "failure")' > /dev/null; then
            echo "âŒ **Status**: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "$RESULTS" | jq -r 'to_entries[] | select(.value.result == "failure") | "- âŒ \(.key)"' >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… **Status**: SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All nightly checks passed!" >> $GITHUB_STEP_SUMMARY
          fi
