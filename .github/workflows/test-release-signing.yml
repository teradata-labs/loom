name: Test Release Signing

on:
  pull_request:
    branches: [main]
    paths:
      - '.github/workflows/release.yml'
      - '.github/workflows/test-release-signing.yml'

permissions:
  contents: read

jobs:
  test-gpg-signing:
    name: Test GPG Signing Process
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0

      - name: Generate test GPG key with passphrase
        run: |
          # Generate a test key with passphrase (matching production setup)
          cat > /tmp/gpg-batch << 'EOF'
          %echo Generating test GPG key with passphrase
          Key-Type: RSA
          Key-Length: 4096
          Name-Real: Test Loom Release Bot
          Name-Email: test-releases@teradata.com
          Expire-Date: 0
          Passphrase: test-passphrase-12345
          %commit
          EOF

          gpg --batch --generate-key /tmp/gpg-batch

          echo "âœ… Test GPG key generated with passphrase"
          gpg --list-keys test-releases@teradata.com

      - name: Export test key
        run: |
          # Export public key
          gpg --armor --export test-releases@teradata.com > test-key.asc
          echo "Public key size: $(wc -c < test-key.asc) bytes"

          # Export and encode private key (simulating the secret)
          # Need to provide passphrase for private key export
          echo "test-passphrase-12345" | gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 --armor --export-secret-keys test-releases@teradata.com | base64 > test-key-private-base64.txt
          echo "Private key (base64) size: $(wc -c < test-key-private-base64.txt) bytes"

          echo "âœ… Keys exported successfully"

      - name: Test key import (simulate workflow step)
        run: |
          # Simulate what happens in release workflow
          base64 -d test-key-private-base64.txt | gpg --import --batch --yes

          echo "âœ… Key import successful"
          gpg --list-secret-keys

      - name: Create test files to sign
        run: |
          # Create test binary and checksum
          echo "This is a test binary" > test-binary.tar.gz
          sha256sum test-binary.tar.gz > test-binary.tar.gz.sha256

          echo "Test files created:"
          ls -lh test-binary*

      - name: Test signing process with passphrase
        run: |
          # Sign the checksum using passphrase (matching production setup)
          echo "test-passphrase-12345" | gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 --detach-sign --armor test-binary.tar.gz.sha256

          if [ ! -f test-binary.tar.gz.sha256.asc ]; then
            echo "âŒ Signature file not created!"
            exit 1
          fi

          echo "âœ… Signature created successfully using passphrase"
          ls -lh test-binary.tar.gz.sha256.asc

          echo ""
          echo "Signature contents:"
          cat test-binary.tar.gz.sha256.asc

      - name: Test signature verification
        run: |
          # Verify the signature
          gpg --verify test-binary.tar.gz.sha256.asc

          echo "âœ… Signature verification successful"

      - name: Test checksum verification
        run: |
          # Verify the checksum
          sha256sum -c test-binary.tar.gz.sha256

          echo "âœ… Checksum verification successful"

      - name: Validate release.yml syntax
        run: |
          echo "Checking release.yml for GPG signing steps..."

          # Check for GPG setup step (composite action)
          if ! grep -q "Setup GPG" .github/workflows/release.yml; then
            echo "âŒ Missing 'Setup GPG' step"
            exit 1
          fi

          # Check for signing steps
          if ! grep -q "Sign checksums (Unix)" .github/workflows/release.yml; then
            echo "âŒ Missing 'Sign checksums (Unix)' step"
            exit 1
          fi

          if ! grep -q "Sign checksums (Windows)" .github/workflows/release.yml; then
            echo "âŒ Missing 'Sign checksums (Windows)' step"
            exit 1
          fi

          # Check for .asc file uploads
          if ! grep -q "\.asc" .github/workflows/release.yml; then
            echo "âŒ Missing .asc file uploads"
            exit 1
          fi

          echo "âœ… All GPG signing steps present in release.yml"

      - name: Summary
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… GPG Signing Test Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ“ Test GPG key generation"
          echo "âœ“ Key export (public + private base64)"
          echo "âœ“ Key import from base64 (workflow simulation)"
          echo "âœ“ File signing (.asc creation)"
          echo "âœ“ Signature verification"
          echo "âœ“ Checksum verification"
          echo "âœ“ release.yml workflow validation"
          echo ""
          echo "ğŸ¯ The signing process is ready for production!"
          echo ""
          echo "Next steps:"
          echo "1. Generate real GPG key (see RELEASE_NOTES_v1.1.0.md)"
          echo "2. Add GPG_PRIVATE_KEY and GPG_PASSPHRASE to GitHub Secrets"
          echo "3. Replace loom-release-key.asc with real public key"
          echo "4. Merge PR and push v1.1.0 tag to trigger release"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  test-slsa-workflow:
    name: Test SLSA Attestation Workflow
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0

      - name: Validate SLSA job syntax
        run: |
          echo "Checking release.yml for SLSA attestation job..."

          # Check for attestations job
          if ! grep -q "create-attestations:" .github/workflows/release.yml; then
            echo "âŒ Missing 'create-attestations' job"
            exit 1
          fi

          # Check for proper permissions
          if ! grep -A10 "create-attestations:" .github/workflows/release.yml | grep -q "attestations: write"; then
            echo "âŒ Missing 'attestations: write' permission"
            exit 1
          fi

          if ! grep -A10 "create-attestations:" .github/workflows/release.yml | grep -q "id-token: write"; then
            echo "âŒ Missing 'id-token: write' permission"
            exit 1
          fi

          # Check for attest action (SHA-pinned or tag)
          if ! grep -q "actions/attest-build-provenance" .github/workflows/release.yml; then
            echo "âŒ Missing attest-build-provenance action"
            exit 1
          fi

          echo "âœ… SLSA attestation job properly configured"

      - name: Summary
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… SLSA Attestation Test Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ“ create-attestations job exists"
          echo "âœ“ Proper permissions configured"
          echo "âœ“ actions/attest-build-provenance@v2 action used"
          echo ""
          echo "ğŸ¯ SLSA provenance will be generated automatically!"
          echo ""
          echo "Note: SLSA attestations use GitHub's OIDC tokens"
          echo "No secrets needed - it works out of the box!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
