name: Publish to Scoop (DISABLED)

permissions:
  contents: read

# DISABLED - Scoop workflow is disabled
# Uncomment the 'on:' section below to re-enable
on:
  workflow_dispatch:
    inputs:
      enabled:
        description: 'Workflow is disabled. Set to manual trigger only if needed.'
        required: false
        type: string

# on:
#   # Run when release is published (after release workflow completes)
#   release:
#     types: [published]
#
#   # Manual trigger
#   workflow_dispatch:
#     inputs:
#       version:
#         description: 'Version to publish (e.g., 1.0.2)'
#         required: true
#         type: string

jobs:
  submit-to-scoop:
    name: Submit PR to Scoop
    runs-on: ubuntu-latest
    steps:
      - name: Checkout loom repo
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Extract version from release tag
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Publishing version: $VERSION"

      - name: Verify release exists
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Check if release exists
          if ! gh release view "v$VERSION" --repo ${{ github.repository }}; then
            echo "Error: Release v$VERSION does not exist"
            exit 1
          fi

          # Verify binaries exist
          URLS=(
            "https://github.com/${{ github.repository }}/releases/download/v${VERSION}/loom-windows-amd64.exe.zip"
            "https://github.com/${{ github.repository }}/releases/download/v${VERSION}/looms-windows-amd64.exe.zip"
          )

          for url in "${URLS[@]}"; do
            echo "Checking $url..."
            if ! curl --head --silent --fail -L "$url" > /dev/null; then
              echo "Error: Binary not found at $url"
              exit 1
            fi
          done

          echo "All release binaries verified"

      - name: Calculate SHA256 hashes
        id: hashes
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Download and hash loom
          curl -L -o loom.zip "https://github.com/${{ github.repository }}/releases/download/v${VERSION}/loom-windows-amd64.exe.zip"
          LOOM_HASH=$(sha256sum loom.zip | awk '{print $1}')

          # Download and hash looms
          curl -L -o looms.zip "https://github.com/${{ github.repository }}/releases/download/v${VERSION}/looms-windows-amd64.exe.zip"
          LOOMS_HASH=$(sha256sum looms.zip | awk '{print $1}')

          echo "loom_hash=$LOOM_HASH" >> $GITHUB_OUTPUT
          echo "looms_hash=$LOOMS_HASH" >> $GITHUB_OUTPUT

          echo "loom hash: $LOOM_HASH"
          echo "looms hash: $LOOMS_HASH"

      - name: Update Scoop manifests
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          LOOM_HASH="${{ steps.hashes.outputs.loom_hash }}"
          LOOMS_HASH="${{ steps.hashes.outputs.looms_hash }}"

          # Update loom.json (using packaging file as template)
          jq --arg ver "$VERSION" \
             --arg hash "$LOOM_HASH" \
             --arg url "https://github.com/teradata-labs/loom/releases/download/v$VERSION/loom-windows-amd64.exe.zip" \
             '.version = $ver | .architecture."64bit".hash = $hash | .architecture."64bit".url = $url' \
             packaging/windows/scoop/loom.json > /tmp/loom.json

          # Update loom-server.json (using packaging file as template)
          jq --arg ver "$VERSION" \
             --arg hash "$LOOMS_HASH" \
             --arg url "https://github.com/teradata-labs/loom/releases/download/v$VERSION/looms-windows-amd64.exe.zip" \
             '.version = $ver | .architecture."64bit".hash = $hash | .architecture."64bit".url = $url' \
             packaging/windows/scoop/loom-server.json > /tmp/loom-server.json

      - name: Fork and clone Scoop Extras
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          # Check if fork exists, if not create it
          if ! gh repo view ${{ github.actor }}/Extras &>/dev/null; then
            echo "Forking ScoopInstaller/Extras..."
            gh repo fork ScoopInstaller/Extras --clone=false
            sleep 5  # Wait for fork to be ready
          fi

          # Clone the fork
          gh repo clone ${{ github.actor }}/Extras scoop-extras
          cd scoop-extras

          # Configure git to use the PAT token for authentication
          git config --global url."https://x-access-token:${GH_TOKEN}@github.com/".insteadOf "https://github.com/"

          # Add upstream (remove first if it exists)
          git remote remove upstream 2>/dev/null || true
          git remote add upstream https://github.com/ScoopInstaller/Extras.git
          git fetch upstream

          # Sync with upstream master
          git checkout master
          git merge upstream/master
          git push origin master

      - name: Create update branch and commit
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd scoop-extras

          # Create branch (delete if exists)
          BRANCH="loom-${VERSION}"
          git push origin --delete "$BRANCH" 2>/dev/null || true
          git checkout -b "$BRANCH"

          # Copy updated manifests
          cp /tmp/loom.json bucket/loom.json
          cp /tmp/loom-server.json bucket/loom-server.json

          # Clone Scoop to get formatjson.ps1
          git clone --depth=1 https://github.com/ScoopInstaller/Scoop.git /tmp/scoop

          # Format manifests with Scoop's official formatter
          echo "Formatting manifests with formatjson.ps1..."
          pwsh /tmp/scoop/bin/formatjson.ps1 -App loom -Dir bucket
          pwsh /tmp/scoop/bin/formatjson.ps1 -App loom-server -Dir bucket

          # Commit
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add bucket/loom.json bucket/loom-server.json
          git commit -m "loom: Update to version $VERSION"

          # Push to fork
          git push origin "$BRANCH"

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BRANCH="loom-${VERSION}"

          cd scoop-extras

          gh pr create \
            --repo ScoopInstaller/Extras \
            --title "loom@$VERSION, loom-server@$VERSION: Update to version $VERSION" \
            --body "Updates Loom to version $VERSION

          ## Changes
          - Update loom to v$VERSION
          - Update loom-server to v$VERSION
          - Update SHA256 hashes

          ## Verification
          - Release: https://github.com/teradata-labs/loom/releases/tag/v$VERSION
          - Binaries verified and hashes calculated from official release

          Automated PR from GitHub Actions." \
            --head "${{ github.actor }}:$BRANCH" \
            --base master

      - name: Summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "âœ… Scoop Extras PR submitted successfully!"
          echo ""
          echo "Version: $VERSION"
          echo "Check PR status at: https://github.com/ScoopInstaller/Extras/pulls"
