# Teradata MCP Server - Docker Backend Example
#
# This example shows how to run a Teradata MCP server inside a Docker container
# for isolated, secure, and observable execution.
#
# Benefits of Docker-based MCP:
# - Isolation: Separate Python environment, no dependency conflicts
# - Security: Sandboxed execution with resource limits
# - Observability: Trace propagation into MCP server operations (Phase 3)
# - Portability: Works on any Docker-enabled host

# Docker Backend Configuration
docker_backend:
  name: teradata-mcp-backend
  description: Docker backend for Teradata MCP server

  # Runtime selection
  runtime_type: RUNTIME_TYPE_PYTHON

  # Python 3.11 base image
  base_image: python:3.11-slim

  # Resource limits
  resource_limits:
    cpu_cores: 2.0
    memory_mb: 2048
    execution_timeout_seconds: 300

  # Python runtime config
  python:
    python_version: "3.11"
    preinstall_packages:
      - teradatasql          # Teradata SQL Driver
      - vantage-mcp-server   # Teradata MCP Server
    use_pip_cache: true

  # Container lifecycle
  lifecycle:
    rotation_interval_hours: 24  # Rotate container daily
    max_executions: 10000
    health_check_interval_seconds: 60
    auto_cleanup: true

# MCP Server Configuration
mcp_server:
  enabled: true
  transport: stdio  # Only stdio supported for Docker MCP servers
  command: python3
  args:
    - -m
    - vantage_mcp.server
  timeout_seconds: 30

  # Environment variables (credentials, connection info)
  env:
    TD_HOST: vantage.teradata.com
    TD_USER: dbc
    # TD_PASSWORD should be set via secure config or keyring
    # DO NOT hardcode passwords in YAML!

  # Tool selection (optional - defaults to all tools)
  tools:
    # Include specific tools
    include:
      - query          # Execute SQL queries
      - schema         # Inspect table schemas
      - explain        # EXPLAIN query plans
      # exclude: ["dangerous_tool"]  # Exclude specific tools

---

# Alternative: Custom Dockerfile Example
#
# For more complex MCP servers, use a custom Dockerfile:

docker_backend:
  name: teradata-mcp-custom
  description: Custom Dockerfile for Teradata MCP

  runtime_type: RUNTIME_TYPE_CUSTOM

  # Path to custom Dockerfile
  dockerfile_path: ./Dockerfile.teradata-mcp

  # Or inline Dockerfile generation
  build_config:
    from_image: python:3.11-slim
    run_commands:
      - apt-get update && apt-get install -y curl
      - pip install --no-cache-dir teradatasql vantage-mcp-server
      - useradd -m -u 1000 mcpuser  # Non-root user
    env:
      PYTHONUNBUFFERED: "1"
    workdir: /app

  resource_limits:
    cpu_cores: 2.0
    memory_mb: 2048

mcp_server:
  enabled: true
  transport: stdio
  command: python3
  args: ["-m", "vantage_mcp.server"]
  env:
    TD_HOST: vantage.teradata.com
    TD_USER: dbc

---

# Usage Examples

# 1. Start MCP server programmatically (Go):
#
# import (
#     "github.com/teradata-labs/loom/pkg/docker"
#     loomv1 "github.com/teradata-labs/loom/gen/go/loom/v1"
# )
#
# // Load config from YAML
# config := loadDockerBackendConfig("teradata-mcp.yaml")
#
# // Create MCP manager
# manager, err := docker.NewMCPServerManager(docker.MCPManagerConfig{
#     Executor: executor,
#     Logger:   logger,
# })
#
# // Start Teradata MCP server
# err = manager.StartMCPServer(
#     ctx,
#     "teradata",
#     config.MCP_Server,
#     config.RuntimeType,
#     config,
# )
#
# // Invoke tool
# result, err := manager.InvokeTool(ctx, "teradata", "query", map[string]interface{}{
#     "sql": "SELECT * FROM DBC.Tables LIMIT 10",
# })

# 2. Via looms server (multi-agent):
#
# looms serve --config project.yaml
#
# # project.yaml contains:
# # mcp_servers:
# #   teradata:
# #     enabled: true
# #     backend: docker  # Use Docker backend
# #     config_file: examples/docker/teradata-mcp.yaml

# 3. Environment variable overrides:
#
# export TD_HOST=my-vantage.example.com
# export TD_USER=myuser
# export TD_PASSWORD=mypassword
#
# # These override env vars in YAML config

---

# Security Best Practices

# 1. Never hardcode credentials in YAML
#    - Use environment variables
#    - Use secret management (Vault, AWS Secrets Manager)
#    - Use loom keyring: `looms config set-key td_password`

# 2. Use non-root user in container
#    - Add to build_config: "useradd -m -u 1000 mcpuser"
#    - Limits damage from container escape

# 3. Set resource limits
#    - Prevents DoS via resource exhaustion
#    - cpu_cores: 2.0, memory_mb: 2048

# 4. Enable audit logging
#    - All MCP tool invocations logged to Hawk
#    - Full trace visibility for compliance

# 5. Network isolation (future)
#    - Restrict container network access
#    - Only allow Teradata connections

---

# Monitoring and Observability

# Health checks:
#   manager.HealthCheck(ctx, "teradata")

# Server info:
#   info, err := manager.GetServerInfo("teradata")
#   fmt.Printf("Container: %s, Healthy: %v\n", info.ContainerID, info.Healthy)

# List all servers:
#   servers := manager.ListMCPServers()

# Traces (Phase 3 - Observability):
#   - All MCP tool calls traced to Hawk
#   - Parent-child span relationships
#   - Full query execution visibility
