# patterns/transcend/sql/customer_health_query_template.yml
name: customer_health_query_template
description: Template for querying customer health scores with business context
library: transcend-sql
version: "1.0"

content: |
  # Customer Health Score Query Template

  ## Available Metrics

  The `customer_health_score` view provides:
  - **health_score** (0-100): Composite health indicator
  - **health_tier**: Excellent | Good | Fair | At Risk | Critical
  - **churn_risk_flag** (0/1): Binary high risk indicator
  - **performance_health_score** (0-25): CPU/IO optimization component
  - **usage_engagement_score** (0-25): Request volume component
  - **feature_adoption_score** (0-25): Strategic feature utilization
  - **resource_optimization_score** (0-25): Storage/compute efficiency

  ## Health Tier Thresholds
  - Excellent: 80-100 → Expansion ready, reference opportunity
  - Good: 65-79 → Standard engagement, quarterly reviews
  - Fair: 50-64 → Proactive support, identify blockers
  - At Risk: 35-49 → Intervention required, bi-weekly check-ins
  - Critical: 0-34 → Executive attention, weekly engagement

  ## Common Query Patterns

  ### At-Risk Customers
  ```sql
  SELECT
    site_id,
    account_name,
    health_score,
    health_tier,
    performance_health_score,
    usage_engagement_score,
    feature_adoption_score,
    last_activity_date
  FROM DataMart_CTO.customer_health_score
  WHERE health_score < 60
  ORDER BY health_score ASC
  ```

  ### Filter by Region/Geography
  ```sql
  SELECT
    h.site_id,
    h.account_name,
    h.health_score,
    v.cloud_region,
    v.deployment_country
  FROM DataMart_CTO.customer_health_score h
  JOIN DataMart_CTO.vantage_sites v
    ON h.site_id = v.site_id
  WHERE v.effective_end_date = '9999-12-31 23:59:59.999999'
    AND h.health_score < 60
    AND v.deployment_country = 'United States'
  ORDER BY h.health_score ASC
  ```

  ### Health Score Distribution
  ```sql
  SELECT
    health_tier,
    COUNT(*) as customer_count,
    CAST(AVG(health_score) AS DECIMAL(5,2)) as avg_score
  FROM DataMart_CTO.customer_health_score
  GROUP BY health_tier
  ORDER BY
    CASE health_tier
      WHEN 'Excellent' THEN 1
      WHEN 'Good' THEN 2
      WHEN 'Fair' THEN 3
      WHEN 'At Risk' THEN 4
      WHEN 'Critical' THEN 5
    END
  ```

  ### Component Deep Dive (Root Cause Analysis)
  ```sql
  SELECT
    site_id,
    account_name,
    health_score,
    performance_health_score,
    usage_engagement_score,
    feature_adoption_score,
    resource_optimization_score,
    CASE
      WHEN performance_health_score < 15 THEN 'Performance Issue'
      WHEN usage_engagement_score < 15 THEN 'Usage Decline'
      WHEN feature_adoption_score < 15 THEN 'Limited Adoption'
      WHEN resource_optimization_score < 15 THEN 'Resource Problem'
      ELSE 'Multiple Factors'
    END as primary_concern
  FROM DataMart_CTO.customer_health_score
  WHERE health_score < 60
  ORDER BY health_score ASC
  ```

  ## Variable Substitution

  When user specifies filters, substitute:
  - {health_threshold} → 60 (or user-specified)
  - {health_tier_filter} → 'At Risk', 'Critical' (or user-specified)
  - {region_filter} → 'Northeast', 'EMEA', etc.
  - {date_range} → log_dt >= CURRENT_DATE - 30

tags:
  - customer-health
  - query-template
  - teradata

variables:
  - name: health_threshold
    type: integer
    default: 60
  - name: health_tier_filter
    type: string
    default: "At Risk"
