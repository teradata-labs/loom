# patterns/transcend/reports/weekly_csm_report.yml
name: weekly_csm_report
description: Generate weekly CSM report with at-risk customers and actions
library: transcend-reports
version: "1.0"

content: |
  # Weekly CSM Report Generator

  Generate a comprehensive weekly report for Customer Success Managers covering:
  1. At-risk customers requiring attention
  2. Health score changes (week-over-week)
  3. Recommended actions by priority
  4. Success stories (improving health scores)

  ## Report Structure

  ### Section 1: Executive Summary

  Query portfolio health distribution:
  ```sql
  SELECT
    health_tier,
    COUNT(*) as customer_count,
    CAST(AVG(health_score) AS DECIMAL(5,2)) as avg_score
  FROM DataMart_CTO.customer_health_score
  GROUP BY health_tier
  ORDER BY
    CASE health_tier
      WHEN 'Excellent' THEN 1
      WHEN 'Good' THEN 2
      WHEN 'Fair' THEN 3
      WHEN 'At Risk' THEN 4
      WHEN 'Critical' THEN 5
    END
  ```

  **Format:**
  ```
  Portfolio Health Summary (as of {date})
  =========================================
  Excellent:  {count} customers ({pct}%) - avg score {avg}
  Good:       {count} customers ({pct}%) - avg score {avg}
  Fair:       {count} customers ({pct}%) - avg score {avg}
  At Risk:    {count} customers ({pct}%) - avg score {avg}
  Critical:   {count} customers ({pct}%) - avg score {avg}

  ðŸš¨ ACTION REQUIRED: {at_risk + critical} customers need immediate attention
  ```

  ### Section 2: Critical Customers (Score < 40)

  ```sql
  SELECT TOP 20
    site_id,
    account_name,
    health_score,
    performance_health_score,
    usage_engagement_score,
    feature_adoption_score,
    last_activity_date,
    CASE
      WHEN performance_health_score < 10 THEN 'Performance Crisis'
      WHEN usage_engagement_score < 10 THEN 'Usage Collapse'
      WHEN feature_adoption_score < 10 THEN 'Abandonment Risk'
      ELSE 'Multiple Issues'
    END as primary_concern
  FROM DataMart_CTO.customer_health_score
  WHERE health_score < 40
  ORDER BY health_score ASC
  ```

  **Format:**
  ```
  ðŸ”´ CRITICAL CUSTOMERS - Executive Attention Required
  ======================================================

  {account_name} (Site: {site_id})
  â€¢ Health Score: {score}/100 (Critical)
  â€¢ Primary Concern: {primary_concern}
  â€¢ Last Activity: {days_ago} days ago
  â€¢ Action: Executive stakeholder call within 48 hours

  [Repeat for each critical customer]
  ```

  ### Section 3: At-Risk Customers (Score 40-59)

  Similar query but with threshold 40-59.

  **Format:**
  ```
  âš ï¸  AT-RISK CUSTOMERS - Intervention Required
  ==============================================

  {account_name} (Site: {site_id})
  â€¢ Health Score: {score}/100 (At Risk)
  â€¢ Primary Concern: {primary_concern}
  â€¢ Action: Bi-weekly check-ins, identify blockers

  [Repeat for each at-risk customer]
  ```

  ### Section 4: Success Stories (Score Improving)

  Identify customers with health score increasing >10 points:
  ```sql
  -- Note: Requires historical comparison logic
  -- For now, identify customers with Excellent/Good scores
  SELECT TOP 10
    site_id,
    account_name,
    health_score,
    performance_health_score,
    usage_engagement_score,
    feature_adoption_score
  FROM DataMart_CTO.customer_health_score
  WHERE health_score >= 80
  ORDER BY health_score DESC
  ```

  **Format:**
  ```
  âœ… SUCCESS STORIES - Healthy Customers
  =======================================

  {account_name} (Site: {site_id})
  â€¢ Health Score: {score}/100 (Excellent)
  â€¢ Strengths: {list components >20}
  â€¢ Opportunity: Expansion positioning, reference program

  [Repeat for top performers]
  ```

  ### Section 5: Weekly Action Plan

  Prioritize actions by urgency:
  ```
  THIS WEEK'S PRIORITIES
  ======================

  1. CRITICAL (Do Today):
     â€¢ {account_1}: Executive call - {primary_concern}
     â€¢ {account_2}: Technical escalation - {primary_concern}

  2. HIGH (This Week):
     â€¢ {account_3}: Bi-weekly check-in scheduled
     â€¢ {account_4}: Feature training session

  3. MEDIUM (Next 2 Weeks):
     â€¢ {account_5}: Quarterly business review prep
     â€¢ {account_6}: Optimization consultation
  ```

  ## Report Delivery

  - **Format**: Markdown for Slack, HTML for email
  - **Frequency**: Every Monday 8 AM
  - **Distribution**: CSM team, VP Customer Success
  - **Archive**: Store in shared drive for tracking

tags:
  - reporting
  - csm
  - weekly

variables:
  - name: report_date
    type: date
    default: "CURRENT_DATE"
