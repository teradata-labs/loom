# patterns/transcend/quality/health_score_validation.yml
name: health_score_validation
description: Validate customer health score calculations and data quality
library: transcend-quality
version: "1.0"

content: |
  # Customer Health Score Data Quality Checks

  Run these validation queries daily after health score refresh to ensure data quality.

  ## Check 1: Score Range Validity

  Ensure all scores are within expected range (0-100):
  ```sql
  SELECT
    'Invalid Health Scores' as check_name,
    COUNT(*) as invalid_count,
    CASE
      WHEN COUNT(*) = 0 THEN 'PASS'
      ELSE 'FAIL'
    END as status
  FROM DataMart_CTO.customer_health_score_tbl
  WHERE health_score < 0
     OR health_score > 100
     OR health_score IS NULL
  ```

  **Expected**: 0 invalid scores
  **Action if FAIL**: Investigate calculation logic in refresh procedure

  ## Check 2: Component Score Consistency

  Verify component scores sum correctly (allowing for proportional adjustment):
  ```sql
  SELECT
    'Component Sum Validation' as check_name,
    COUNT(*) as invalid_count,
    CASE
      WHEN COUNT(*) = 0 THEN 'PASS'
      ELSE 'FAIL'
    END as status
  FROM DataMart_CTO.customer_health_score_tbl
  WHERE health_score IS NOT NULL
    AND ABS(health_score - (
      COALESCE(performance_health_score, 0) +
      COALESCE(usage_engagement_score, 0) +
      COALESCE(feature_adoption_score, 0) +
      COALESCE(resource_optimization_score, 0)
    )) > 5  -- Allow 5-point tolerance for rounding/proportional adjustment
  ```

  **Expected**: 0 invalid sums
  **Action if FAIL**: Check proportional scoring logic

  ## Check 3: Customer Coverage

  Ensure all active customers have health scores:
  ```sql
  SELECT
    'Customer Coverage' as check_name,
    COUNT(DISTINCT v.site_id) as total_active_customers,
    COUNT(DISTINCT h.site_id) as scored_customers,
    CASE
      WHEN CAST(COUNT(DISTINCT h.site_id) AS FLOAT) /
           CAST(COUNT(DISTINCT v.site_id) AS FLOAT) >= 0.95
      THEN 'PASS'
      ELSE 'FAIL'
    END as status
  FROM DataMart_CTO.vantage_sites v
  LEFT JOIN DataMart_CTO.customer_health_score_tbl h
    ON v.site_id = h.site_id
  WHERE v.effective_end_date = '9999-12-31 23:59:59.999999'
  ```

  **Expected**: >95% coverage
  **Action if FAIL**: Investigate missing customer data

  ## Check 4: Freshness Check

  Verify data was refreshed within SLA (4 hours):
  ```sql
  SELECT
    'Data Freshness' as check_name,
    MAX(refresh_timestamp) as last_refresh,
    CASE
      WHEN MAX(refresh_timestamp) >= CURRENT_TIMESTAMP - INTERVAL '4' HOUR
      THEN 'PASS'
      ELSE 'FAIL'
    END as status
  FROM DataMart_CTO.customer_health_score_tbl
  ```

  **Expected**: Refreshed within last 4 hours
  **Action if FAIL**: Check workflow execution logs

  ## Check 5: Anomaly Detection

  Identify sudden changes in health score distribution:
  ```sql
  SELECT
    health_tier,
    COUNT(*) as customer_count
  FROM DataMart_CTO.customer_health_score_tbl
  GROUP BY health_tier
  ORDER BY
    CASE health_tier
      WHEN 'Excellent' THEN 1
      WHEN 'Good' THEN 2
      WHEN 'Fair' THEN 3
      WHEN 'At Risk' THEN 4
      WHEN 'Critical' THEN 5
    END
  ```

  Compare to historical baseline. Alert if:
  - "Critical" customers increase >20% day-over-day
  - "Excellent" customers decrease >20% day-over-day

  ## Quality Score Summary

  Generate overall quality score (0-100):
  ```
  Quality Score = (
    (Check1_pass * 25) +
    (Check2_pass * 25) +
    (Check3_pass * 25) +
    (Check4_pass * 25)
  )
  ```

  **Expected**: 100 (all checks pass)
  **Action if <100**: Investigate failing checks, alert data team

tags:
  - data-quality
  - validation
  - monitoring
