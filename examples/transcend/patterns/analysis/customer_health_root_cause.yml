# patterns/transcend/analysis/customer_health_root_cause.yml
name: customer_health_root_cause_analysis
description: Analyze root causes of declining customer health scores
library: transcend-analysis
version: "1.0"

content: |
  # Customer Health Root Cause Analysis

  When asked to analyze why a customer's health score is declining, follow these steps:

  ## Step 1: Get Current Health Score

  Query the customer_health_score view to get current state:
  ```sql
  SELECT
    site_id,
    account_name,
    health_score,
    health_tier,
    performance_health_score,
    usage_engagement_score,
    feature_adoption_score,
    resource_optimization_score,
    last_activity_date
  FROM DataMart_CTO.customer_health_score
  WHERE account_name = '{customer_name}'
     OR site_id = '{site_id}'
  ```

  ## Step 2: Identify Lowest Component Score

  The component with the lowest score (0-25 range) is typically the primary driver.

  **Component thresholds:**
  - 20-25: Excellent
  - 15-19: Good
  - 10-14: Fair
  - 5-9: At Risk
  - 0-4: Critical

  ## Step 3: Drill into Component Details

  ### If Performance Health is Low (<15)
  Query CPU utilization trends:
  ```sql
  SELECT
    log_dt,
    avg_cpu_utilization,
    peak_cpu_utilization,
    avg_io_wait_time
  FROM DataMart_CTO.sites_daily_cpu_utilization
  WHERE site_id = '{site_id}'
    AND log_dt >= CURRENT_DATE - 30
  ORDER BY log_dt DESC
  ```

  **Interpretation:**
  - CPU > 85%: Capacity constraint, consider upsizing
  - IO wait > 30: Storage bottleneck, investigate queries
  - Both high: System overloaded, immediate action needed

  ### If Usage Engagement is Low (<15)
  Query request trends:
  ```sql
  SELECT
    log_dt,
    total_requests,
    failed_requests,
    avg_requests_per_hour
  FROM DataMart_CTO.sites_daily_requests
  WHERE site_id = '{site_id}'
    AND log_dt >= CURRENT_DATE - 30
  ORDER BY log_dt DESC
  ```

  **Interpretation:**
  - Declining requests: User adoption issue, engagement needed
  - High failure rate: Technical problems blocking usage
  - Zero requests: System down or project abandoned

  ### If Feature Adoption is Low (<15)
  Query feature usage:
  ```sql
  SELECT
    f.feature_name,
    f.feature_category,
    SUM(sfr.request_count) as total_uses
  FROM DataMart_CTO.sites_daily_feature_requests sfr
  JOIN DataMart_CTO.query_features f ON sfr.feature_id = f.feature_id
  WHERE sfr.site_id = '{site_id}'
    AND sfr.log_dt >= CURRENT_DATE - 30
  GROUP BY f.feature_name, f.feature_category
  ORDER BY total_uses DESC
  ```

  **Interpretation:**
  - Using only basic features: Education opportunity
  - No strategic features: Not leveraging platform value
  - Single feature category: Limited use case breadth

  ### If Resource Optimization is Low (<15)
  Query storage utilization:
  ```sql
  SELECT
    log_dt,
    total_perm_space_gb,
    used_perm_space_gb,
    utilization_pct
  FROM DataMart_CTO.sites_daily_storage_utilization
  WHERE site_id = '{site_id}'
    AND log_dt >= CURRENT_DATE - 30
  ORDER BY log_dt DESC
  ```

  **Interpretation:**
  - <40% utilization: Over-provisioned, cost optimization opportunity
  - >90% utilization: Under-provisioned, expansion needed
  - 60-85%: Optimal range (target state)

  ## Step 4: Generate Recommendations

  Based on findings, provide specific actionable recommendations:

  **Performance Issues:**
  - "CPU consistently >85% - recommend upsizing compute tier"
  - "High IO wait - review slow queries with customer"

  **Usage Decline:**
  - "Requests down 40% month-over-month - schedule engagement call"
  - "High failure rate (15%) - investigate technical errors"

  **Limited Adoption:**
  - "Using only 2 feature categories - schedule feature training"
  - "No ML features used - introduce ClearScape Analytics"

  **Resource Problems:**
  - "25% utilization - downsize to reduce costs by 40%"
  - "92% capacity - expansion needed within 30 days"

  ## Step 5: Historical Comparison (if available)

  Compare to 30/60/90 days ago to identify trends.

tags:
  - customer-health
  - root-cause
  - analysis

variables:
  - name: customer_name
    type: string
  - name: site_id
    type: string
