# TD.rom v2 - Teradata SQL

---

## ‚ö†Ô∏è FUNDAMENTAL RULE: TERADATA SQL ONLY

**YOU ARE CONNECTED TO A TERADATA DATABASE.**

When writing SQL queries, you MUST use **Teradata SQL dialect ONLY**.

‚ùå **DO NOT use:**
- MySQL syntax (LIMIT, `column`, CONCAT())
- PostgreSQL syntax (::type, column::type)
- Oracle syntax (ROWNUM, (+) joins)
- SQL Server syntax (SELECT TOP ... PERCENT, GETDATE())
- Standard SQL that Teradata doesn't support

‚úÖ **ONLY use Teradata-specific syntax:**
- TOP and SAMPLE for row limiting
- CAST() for type conversion
- || for string concatenation
- QUALIFY for window function filtering
- CURRENT_DATE for date functions

**If you're unsure whether syntax is Teradata-compatible, use HELP TABLE or check DBC system views first.**

This database will reject any non-Teradata SQL with syntax errors. When in doubt, use the most basic Teradata-compatible syntax.

---

## üö® RULE 1: NEVER Use LIMIT (Instant Error!)

Teradata does NOT support LIMIT clause. Using it causes instant failure.

**Trigger:** Whenever you want to limit result rows
**Action:** Use TOP or SAMPLE instead

‚ùå **NEVER:**
```sql
SELECT * FROM table ORDER BY col DESC LIMIT 10;
-- Error 3706: Syntax error near 'LIMIT' keyword
```

‚úÖ **ALWAYS:**
```sql
-- Option 1: TOP at beginning (most common)
SELECT TOP 10 * FROM table ORDER BY col DESC;

-- Option 2: SAMPLE at end (for random sampling)
SELECT * FROM table ORDER BY col DESC SAMPLE 10;
```

---

## üö® RULE 2: ALWAYS Filter Large Tables by Date (Prevents Overflow!)

Enterprise tables have millions/billions of rows spanning years. Aggregating without date filters causes numeric overflow.

**Trigger:** Before writing SUM(), AVG(), COUNT() on any table
**Action:** Add WHERE log_dt >= CURRENT_DATE - N

‚ùå **NEVER:**
```sql
SELECT SUM(impact_io_qty) FROM acc_ted_con_vw.dbp_featusg_agg_dly;
-- Error 2616: Numeric overflow occurred during computation
-- Reason: Summing billions of values across years
```

‚úÖ **ALWAYS:**
```sql
-- Add date filter (30-90 days max for large tables)
SELECT SUM(impact_io_qty)
FROM acc_ted_con_vw.dbp_featusg_agg_dly
WHERE log_dt >= CURRENT_DATE - 30;  -- REQUIRED!
```

**How to know if table is "large":**
```sql
-- Quick size check (runs in <1 second)
SELECT COUNT(*) FROM table SAMPLE 1000;
-- If result > 100 rows ‚Üí table has > 100K rows ‚Üí MUST filter by date
```

---

## üö® RULE 3: Use BIGINT for Large Number Aggregations

Columns like `impact_io_qty`, `impact_cpu_qty`, `peak_spool_bytes_used_qty` contain enterprise-scale metrics (billions). Standard SUM() overflows.

**Trigger:** Summing metrics with "impact", "total", "peak", "bytes" in name
**Action:** Cast to BIGINT before SUM, then cast result back

‚ùå **CAUSES OVERFLOW:**
```sql
SELECT SUM(impact_io_qty) FROM table WHERE ...;
-- Error 2616: Numeric overflow
```

‚úÖ **PREVENTS OVERFLOW:**
```sql
SELECT CAST(SUM(CAST(impact_io_qty AS BIGINT)) AS DECIMAL(20,2)) as total_io
FROM table
WHERE log_dt >= CURRENT_DATE - 30;
```

---

## üö® RULE 4: GROUP BY + ORDER BY Expression Rules

When GROUP BY uses an expression (like EXTRACT), ORDER BY cannot use the alias. Must use ordinal position.

**Trigger:** GROUP BY with EXTRACT(), CAST(), or any expression
**Action:** ORDER BY 1 (not by alias)

‚ùå **FAILS:**
```sql
SELECT EXTRACT(MONTH FROM log_dt) as month, COUNT(*)
FROM table
GROUP BY EXTRACT(MONTH FROM log_dt)
ORDER BY month;
-- Error 3707: Syntax error - can't use alias after GROUP BY expression
```

‚úÖ **WORKS:**
```sql
SELECT CAST(EXTRACT(MONTH FROM log_dt) AS INTEGER) as month_num, COUNT(*)
FROM table
GROUP BY CAST(EXTRACT(MONTH FROM log_dt) AS INTEGER)
ORDER BY 1;  -- Use ordinal position, not alias
```

**Avoid these aliases:** month, year, date, time, order, group (reserved words)

---

## üö® RULE 5: Stop on Circuit Breaker (Cascading Failures!)

After 10 consecutive query failures, the system triggers a circuit breaker and blocks ALL queries for 20-30 seconds.

**Trigger:** See error "circuit breaker open: too many consecutive failures"
**Action:** STOP, analyze, fix root cause, wait, then retry

‚ùå **DON'T:**
- Keep trying different queries (makes it worse)
- Ignore the circuit breaker message

‚úÖ **DO:**
1. STOP executing new queries immediately
2. Look at last 5-10 failed queries - find the pattern
   - All missing date filters? ‚Üí Add WHERE log_dt >= ...
   - All using LIMIT? ‚Üí Change to TOP or SAMPLE
   - All overflowing? ‚Üí Add BIGINT casts
3. Wait 30 seconds for circuit breaker to reset
4. Start with simple validation query:
   ```sql
   SELECT COUNT(*) FROM table SAMPLE 100;
   ```
5. Then retry with FIXED queries

---

## Quick Reference Card

| Problem | Solution |
|---------|----------|
| Want to limit rows | Use `SELECT TOP N` or `SAMPLE N` (NEVER LIMIT) |
| Aggregating on large table | Add `WHERE log_dt >= CURRENT_DATE - 30` first |
| Numeric overflow | Wrap in `CAST(SUM(CAST(col AS BIGINT)) AS DECIMAL(20,2))` |
| GROUP BY expression | Use `ORDER BY 1` (ordinal) not alias |
| Circuit breaker open | Stop, analyze failures, wait 30s, retry with fixes |

---

**Remember:** These 5 rules prevent 95% of Teradata query failures. When in doubt, check table size and add date filters.

---

## üîß BONUS: Common Teradata-Specific Issues

### HELP TABLE Before Query (Critical!)
**Always verify schema before querying a new table**

‚ùå **DON'T assume column names:**
```sql
-- Assuming columns exist:
SELECT calendar_dt, cust_site_id FROM table WHERE ...
-- Error 5628: Column calendar_dt not found
```

‚úÖ **DO verify with HELP TABLE first:**
```sql
-- Step 1: Get schema
HELP TABLE database.tablename;

-- Step 2: See sample data
SELECT TOP 5 * FROM database.tablename;

-- Step 3: Then query with correct column names
SELECT log_dt, acct_nbr FROM database.tablename WHERE ...
```

### Unsupported Functions
These functions **do NOT exist** in Teradata:
- ‚ùå `TYPEOF()` - no type inspection
- ‚ùå `JSON_EXTRACT()` - limited JSON support
- ‚ùå `ISNULL()` - use `COALESCE()` or `IS NULL`

### TOP and SAMPLE Cannot Mix
‚ùå `SELECT TOP 100 * FROM table SAMPLE 100;` - Error 6916
‚úÖ `SELECT TOP 100 * FROM table;` - Limits result
‚úÖ `SELECT * FROM table SAMPLE 100;` - Samples rows
